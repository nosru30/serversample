# serversample

## Environment variables

- `DATABASE_URL`: connection string for the database. Tests use a SQLite file if
  not provided.
- `CORS_ALLOW_ORIGINS`: comma-separated list of origins allowed by CORS.
  Defaults to `*` to permit any origin.

## Development setup

1. Run `./setup_venv.sh` to create a local Python virtual environment named `venv`
   and install dependencies.
2. Activate the environment with `source venv/bin/activate` whenever developing
   or running tests.
3. Ensure the virtual environment is active whenever running `uvicorn` or using the Procfile.

## API endpoints

The application exposes `/tasks` for CRUD operations on tasks persisted in the
configured database. Tasks may include nested `sub_tasks`, which are stored as
rows referencing their parent task. On startup, existing tables are dropped and
recreated automatically so the schema is always in sync with the models.

## Attendance Reporting App (Prototype)

The API is being expanded from a simple task tracker into a prototype attendance
reporting system. Key design decisions are summarized below.

- **Timezone handling**: All timestamps are stored in UTC (UNIX epoch). Client
  applications convert to local time for display and input.
- **Cross-day shifts**: End times earlier than start times are permitted to
  handle overnight work.
- **Break constraints**: Validation of break duration is minimal in the
  prototype; UI may warn users if needed.
- **Notes**: A `NoteMaster` table provides predefined notes alongside a free
  text field.
- **Roles**: Access control is based on roles stored in a `Role` master table.
  Initial roles are `employee` and `admin`.
- **Core entities**: `User`, `Employee`, `Attendance`, `Role`, `Department`,
  `NoteMaster`, and `AttendanceNote` form the schema.
- **Planned endpoints**: login, retrieving the current user, CRUD on
  attendances, employee administration, and master data management.
- **Migration & dependencies**: Migrations will run on startup rather than on
  router import, and the project requires Pydantic v2.

### Entity Overview

| Entity | Purpose | Key Columns |
| --- | --- | --- |
| `User` | Authentication | `id`, `email` (unique), `password`, `role_id` |
| `Employee` | Attendance target | `id`, `user_id` (unique), `employee_id` (unique), `name`, `department_id` |
| `Attendance` | Daily record | `id`, `employee_id`, `date`, `start_time`, `end_time`, `break_duration_minutes`, `notes_free_text` |
| `NoteMaster` | Predefined notes | `id`, `name` (unique) |
| `AttendanceNote` | Link attendance to notes | `attendance_id`, `note_master_id` |
| `Role` | Authorization | `id`, `name` |
| `Department` | Optional department info | `id`, `name` |

Unique constraints include `(employee_id, date)` in `Attendance` and `(attendance_id, note_master_id)` in `AttendanceNote`.

### Planned API Endpoints

- `POST /login` – obtain a token
- `GET /me` – current user information
- `GET /attendances?month=YYYY-MM` – list own attendance records
- `POST /attendances` – create/update an attendance record
- `DELETE /attendances/{attendanceId}` – remove a record
- Admin endpoints (`/employees`, `/departments` etc.) will be added later.

### Front-end Implementation Notes

The OpenAPI schema for these endpoints is automatically generated by FastAPI and
is available at `/openapi.json` (interactive docs under `/docs`).

Key constraints for the current prototype:

* All timestamp fields (`date`, `start_time`, `end_time`) must be provided in
  ISO 8601 format and are stored internally in UTC. Clients should handle local
  time conversion.
* `end_time` may be earlier than `start_time` to support overnight shifts.
* `Authorization` headers must include `Bearer <token>` returned from
  `POST /login`.
* Only minimal validation is applied to break durations and note fields; the
  front end may implement additional checks as needed.

These constraints will evolve, but the generated schema can be used as the
authoritative reference for field names and types when implementing the
front-end.
